name: ci

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-test-analyze:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Temurin JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: 'maven'

      - name: Show Java & Maven versions
        run: |
          java -version
          mvn -v

      - name: Build & unit tests (Maven)
        run: mvn -B -DskipTests=false clean verify

      # ---------- SonarQube (self-hosted) ----------
      # Repo secrets required:
      #   SONAR_HOST_URL = http://<your-ec2-ip>:9000
      #   SONAR_TOKEN    = <My Account -> Security -> Tokens>
      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v2.3
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=boardgame
            -Dsonar.projectName=Boardgame

      # Quality Gate still enforces your Sonar rules; remove this step if you also want it non-blocking
      - name: SonarQube Quality Gate
        uses: SonarSource/sonarqube-quality-gate-action@v1.1.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      # ---------- Build Docker image ----------
      - name: Build Docker image
        run: |
          IMAGE=boardgame:${{ github.sha }}
          docker build -t $IMAGE .

      # ---------- Trivy scan (non-blocking) ----------
      - name: Cache Trivy DB
        uses: actions/cache@v4
        with:
          path: ~/.cache/trivy
          key: trivy-db-${{ runner.os }}-v1

      - name: Trivy image scan (non-blocking)
        id: trivy
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: boardgame:${{ github.sha }}
          exit-code: '0'             # << do not fail the job on any findings
          severity: 'UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL'
          ignore-unfixed: false
          format: 'table'
          output: 'trivy-image-report.txt'

      - name: Upload Trivy report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-image-report
          path: trivy-image-report.txt

  # Optional: minimal failure notifier (will trigger only if *other* steps fail)
  notify-on-failure:
    needs: build-test-analyze
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - run: echo "❌ CI failed (but not due to Trivy). Check logs above."
