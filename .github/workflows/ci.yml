name: ci

on:
  push:
    branches: [ main ]
  pull_request:

permissions:
  id-token: write   # required for OIDC (assume-role)
  contents: read

jobs:
  build-test-analyze:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # Map secrets to env so we can use them in `if:` conditions
    env:
      SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      AWS_ROLE_TO_ASSUME: ${{ secrets.AWS_ROLE_TO_ASSUME }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
      ECR_REPO: ${{ secrets.ECR_REPO }}
      ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Temurin JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven
          check-latest: true

      - name: Show Java & Maven versions (sanity)
        run: |
          echo "JAVA_HOME=$JAVA_HOME"
          which java || true
          which javac || true
          java -version
          mvn -v

      - name: Force Maven toolchain to JDK 21
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/toolchains.xml <<'XML'
          <?xml version="1.0" encoding="UTF-8"?>
          <toolchains xmlns="http://maven.apache.org/TOOLCHAINS/1.1.0"
                      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                      xsi:schemaLocation="http://maven.apache.org/TOOLCHAINS/1.1.0 https://maven.apache.org/xsd/toolchains-1.1.0.xsd">
            <toolchain>
              <type>jdk</type>
              <provides>
                <version>21</version>
              </provides>
              <configuration>
                <jdkHome>${env.JAVA_HOME}</jdkHome>
              </configuration>
            </toolchain>
          </toolchains>
          XML
          cat ~/.m2/toolchains.xml

      - name: Build & unit tests (Maven)
        run: mvn -B -DskipTests=false clean verify

      # ---------- SonarQube ----------
      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v2.3
        env:
          SONAR_TOKEN: ${{ env.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=boardgame
            -Dsonar.projectName=Boardgame

      - name: SonarQube Quality Gate
        uses: SonarSource/sonarqube-quality-gate-action@v1.1.0
        env:
          SONAR_TOKEN: ${{ env.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}

      # ---------- Build Docker image ----------
      - name: Build Docker image
        run: |
          IMAGE=boardgame:${{ github.sha }}
          docker build -t $IMAGE .

      # ---------- Trivy (non-blocking) ----------
      - name: Cache Trivy DB
        uses: actions/cache@v4
        with:
          path: ~/.cache/trivy
          key: trivy-db-${{ runner.os }}-v1

      - name: Trivy image scan (non-blocking)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: boardgame:${{ github.sha }}
          exit-code: '0'
          format: 'table'
          output: 'trivy-image-report.txt'

      - name: Upload Trivy report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-image-report
          path: trivy-image-report.txt

      # ---------- Push image to Amazon ECR ----------
      - name: Configure AWS credentials (OIDC role)
        if: ${{ env.AWS_ROLE_TO_ASSUME != '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Configure AWS credentials (access keys)
        if: ${{ env.AWS_ROLE_TO_ASSUME == '' && env.AWS_ACCESS_KEY_ID != '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Tag & Push image to ECR
        run: |
          REGISTRY="${{ steps.ecr.outputs.registry }}"
          if [ -n "${{ env.ECR_REGISTRY }}" ]; then
            REGISTRY="${{ env.ECR_REGISTRY }}"
          fi
          if [ -z "${{ env.ECR_REPO }}" ]; then
            echo "ECR_REPO secret is required (e.g., 'boardgame')."; exit 1
          fi
          SRC="boardgame:${{ github.sha }}"
          DST_SHA="$REGISTRY/${{ env.ECR_REPO }}:${{ github.sha }}"
          DST_LATEST="$REGISTRY/${{ env.ECR_REPO }}:latest"
          docker tag "$SRC" "$DST_SHA"
          docker tag "$SRC" "$DST_LATEST"
          docker push "$DST_SHA"
          docker push "$DST_LATEST"
