name: ci

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-test-analyze:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Temurin JDK 21
      # Installs JDK 21 and sets JAVA_HOME and PATH for this job
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: 'maven'
          check-latest: true

      - name: Show Java & Maven versions (sanity)
        run: |
          echo "JAVA_HOME=$JAVA_HOME"
          which java || true
          which javac || true
          java -version
          mvn -v

      - name: Force Maven toolchain to JDK 21
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/toolchains.xml <<'XML'
          <?xml version="1.0" encoding="UTF-8"?>
          <toolchains xmlns="http://maven.apache.org/TOOLCHAINS/1.1.0"
                      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                      xsi:schemaLocation="http://maven.apache.org/TOOLCHAINS/1.1.0 https://maven.apache.org/xsd/toolchains-1.1.0.xsd">
            <toolchain>
              <type>jdk</type>
              <provides>
                <version>21</version>
              </provides>
              <configuration>
                <jdkHome>${env.JAVA_HOME}</jdkHome>
              </configuration>
            </toolchain>
          </toolchains>
          XML
          echo "Wrote ~/.m2/toolchains.xml:"
          cat ~/.m2/toolchains.xml

      - name: Build & unit tests (Maven)
        run: mvn -B -DskipTests=false clean verify

      # ---------- SonarQube (self-hosted) ----------
      # Repo secrets required:
      #   SONAR_HOST_URL = http://<your-ec2-ip>:9000
      #   SONAR_TOKEN    = <My Account -> Security -> Tokens>
      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v2.3
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=boardgame
            -Dsonar.projectName=Boardgame

      - name: SonarQube Quality Gate
        uses: SonarSource/sonarqube-quality-gate-action@v1.1.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      # ---------- Build Docker image ----------
      - name: Build Docker image
        run: |
          IMAGE=boardgame:${{ github.sha }}
          docker build -t $IMAGE .

      # ---------- Trivy scan (non-blocking) ----------
      - name: Cache Trivy DB
        uses: actions/cache@v4
        with:
          path: ~/.cache/trivy
          key: trivy-db-${{ runner.os }}-v1

      - name: Trivy image scan (non-blocking)
        id: trivy
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: boardgame:${{ github.sha }}
          exit-code: '0'             # never fail the job on findings
          severity: 'UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL'
          ignore-unfixed: false
          format: 'table'
          output: 'trivy-image-report.txt'

      - name: Upload Trivy report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-image-report
          path: trivy-image-report.txt

  notify-on-failure:
    needs: build-test-analyze
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - run: echo "‚ùå CI failed. Check logs above."
